pipeline {
    agent any
    parameters {
        string(name: 'branch', defaultValue: '$GIT_BRANCH', description: 'Descripci칩n del par치metro 1')
        string(name: 'buildNumber', defaultValue: '$BUILD_NUMBER', description: 'Descripci칩n del par치metro 2')
    }
    stages {
        stage('Create Docker Image') {
            steps {
                sh 'echo $branch'
                sh 'docker image ls -a'
                // sh 'docker build -t devops_project_ui-$simpleBranch:1.0.0-$buildNumber .'
                dir ('DevOps_Project_UI'){
                    sh 'docker build -t devops_project_ui-$branch:1.0.0-$buildNumber .'
                    sh 'docker image ls -a'
                    sh 'docker container ls -a'
                }
                
            }
        }
        stage('Stop containers') {
            steps {
                    sh '''
                        running=$(docker ps --filter name=devops_ui* --filter status=running -aq)
                        if [ -z $running]
                        then 
                            #Print error message 
                            echo "No hay contenedores ejecutandose" 
                       else 
                           #Se apagan los contenedores con el mismo nombre 
                           docker stop $running
                        fi
                    '''
                
                // }                
            }
        }
        stage('Run container') {
            steps {
                dir('DevOps_Project_UI'){
                    sh 'docker container ls -a'
                    sh 'docker run -d --name devops_ui-$buildNumber -p 4200:80 devops_project_ui-$branch:1.0.0-$buildNumber'
                }
                
            }
        }
        stage('Run UI on Virtual Machine') {
            steps {
                sh '''
                    sshpass -p vboxuser2 ssh -t -t vboxuser2@192.168.1.71 -v "cd /Documentos; if [ !-d DevOps_Project_UI ] then git clone https://github.com/AndreaSaenz/DevOps_Project_UI.git ; fi cd /DevOps_Project_UI; git checkout develop; git fetch; git pull; cd /DevOps_Project_UI; npm install; npm run build; ng serve; exit" 
                    
                '''
            }
        }
    }
}